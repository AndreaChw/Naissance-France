---
title: "Determinants de la baisse des naissances en France de 1991 à 2019"
output: html_document
author:
  - name : "NDAYA NSABUA Niclette"
  - name : "FEHRI Mehdi"
  - name : "CHAHWAN Andrea"
  - name : "DELPONT Lauriane" 
---

```{r setup, include=FALSE}

library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(writexl)
library(tseries)

data <- read_excel("C:/Users/PC/Documents/Cours/Master/S1/Econométrie TD/Projet/Data R Ajustée.xlsx") %>%
  rename_with(~ gsub("-", "_", .), everything()) %>%
  # Suppression de certaines variables jugées non pertinantes
  select(-fem, -sco_jeune, -pop, -parc_logement, -viedans5, -agemat, -solo, -loyers, 
         -tailleMenage, -consoalcool, -opi_surpoids, - opi_nervosite, -chomagefem,
         -inegalité_w_privée, -tx_emploifem, -wage_h, -opi_inquietude,
         -cadre_vie,-opi_guerre, -opi_violence,-confiance_menage,-opi_affaires)
numeric_cols <- setdiff(colnames(data), c("Temps", "fec"))


```

## I. Introduction
### I.1. Choix de la variable dépendante
En 2023, 678.000 enfants sont nés en France, c'est le chiffre le plus faibe depuis 1938 (hors période de guerre).

Cette baisse de la natalité est devenue un sujet central au point où Emmanuel Macron parle de la nécéssité d'un *"réarmement démographique"* pour la France. Nous avons donc décidé d'étudier cette question et de tenter de déterminer **les déterminants de cette baisse de la natalité**.

Nous nous sommes tout d'abord interessés au **taux de natalité**, c'est à dire le nombre de naissance rapporté à la population. Cependant, une première regression a mis en évidence que la majeure partie de cette variable est déterminée par des variables démographiques.

Nous avons donc décidé de prendre le **taux de fécondité**, qui correspond au nombre de naissances sur le nombre de femmes en âge de procréer.

```{r fec, echo=FALSE, warning=FALSE}
print(
  ggplot(data, aes_string(x = "Temps", y = "fec")) +
    geom_line(color = "blue") +
    labs(title = paste("Variation du taux de fécondité de 1991 à 2020"), x = "Temps", y = "fec")
)
numeric_cols <- setdiff(colnames(data), c("Temps", "fec"))

```

Nous avons sélectionné la plage de temps pour laquelle nous avions le plus de données, c'est à dire 1991-2019.
Nous avons choisi d'exclure l'année 2020 car la crise du covid a fortement impacté le taux de fécondité. 

### I.2. Les variables explicatives
Nous nous sommes d'abord concertés pour déterminer toutes les varaibles qui pourraient potentiellement expliquer ou être corrélées avec le taux de fécondité, organisées en 5 catégories :

  - Facteurs socio-culturels
  
  - Facteurs démographiques et biologiques
  
  - Facteurs économiques et politiques
  
  - Facteurs liés au travail et à l'éducation
  
  - Facteurs individuels et comportementaux

Nous avons réuni **37 variables explicatives**.

Nous avons identifié celles avec qui avaient le plus de corrélation avec les autres, afin de sélectionner les plus **pertinantes**.

![image](C:/Users/PC/Documents/Cours/Master/S1/Econométrie TD/Projet/ReprésentationMDS.jpg)

Finalement, nous avons retenues les variables suivantes :
*(mettre la présentation des variables ici mais on les a pas décidées encore)*

## II. Premier traitement de nos variables explicatives
### II.1. Interpolation linéaire des années (1991 - 2019) et création des variables décalées `lag`

Nous avons régularisé la variable temps en générant une séquence trimestrielle couvrant la période 1991-2019. Les valeurs manquantes des variables numériques ont été complétées à l’aide d’une interpolation linéaire, permettant d’estimer les données manquantes en se basant sur les observations existantes. Cette étape garantit un jeu de données uniforme sur toute la période. 

Ensuite, nous avons utilisé une fonction `lag` pour créer des variables décalées, en considérant que la natalité à une période donnée *(t)* est influencée par les politiques familiales et son propre niveau à la période précédente *(t-1)*. Cette hypothèse repose sur le fait qu’une gestation dure environ **9 mois**, ce qui implique un effet différé des facteurs explicatifs d’une année sur les naissances de l'année suivante 

```{r libraries, include=FALSE}
library(readxl)
library(tseries)
library(ggplot2)
library(dplyr)

```

```{r interpolation, include= TRUE, warning=FALSE}
# Interpolation trimestrielle et création des variables décalées (lags)
data_clean <- data %>%
  complete(Temps = seq(min(Temps), max(Temps), by = 0.25)) %>%
  mutate(across(all_of(numeric_cols),
                ~ approx(Temps[!is.na(.)], .[!is.na(.)], xout = Temps)$y)) %>%
  arrange(Temps) %>%
  mutate(across(setdiff(numeric_cols, "fec"), ~ lag(., n = 4), .names = "lag_{col}")) %>%
  drop_na(starts_with("lag_"))

# Sélectionner uniquement les colonnes nécessaires pour le modèle
data_work <- data_clean %>%
  select(Temps, fec, starts_with("lag_"))

```


### II.2. Création d’un jeu de données sans les outliers et tableau récapitulatif 

Nous créons un nouveau jeu de données, `data_work2`, en supprimant les observations identifiées comme outliers, garantissant un ensemble de données nettoyées et prêtes pour les analyses.
En complément,un tableau récapitulatif liste les observations extrêmes avec leur période `(Temps)`, leur valeur de fécondité `(fec)`, et leurs résidus standardisés `(Std_Resid)`.

```{r bla, include=FALSE}
# Sélectionner uniquement les colonnes nécessaires pour le modèle
data_work <- data_clean %>%
  select(Temps, fec, starts_with("lag_"))

# Sauvegarder le DataFrame intermédiaire
write_xlsx(data_work, "C:/Users/PC/Documents/Cours/Master/S1/Econométrie TD/Projet/Data_Work.xlsx")
cat("Le fichier 'Data_Work.xlsx' a été sauvegardé après l'interpolation et le lag.\n")

#préparation des variables instrumentales candidates (condition nécessaire pour les pb d'endogénéités)
Variables_instrumentales <- data_work %>% select(Temps, lag_opi_depression, lag_depseniors, lag_synthé_Oiseau, lag_lt_interest_rate, 
                                                 lag_opi_famille, lag_opi_work_fem, lag_pib_hab, lag_acceuilenf, lag_opi_niveau_vie)

# Mise à jour de `data_work` en supprimant les variables instrumentales
data_work <- data_work %>% select(-c(lag_opi_depression, lag_depseniors, lag_synthé_Oiseau, lag_lt_interest_rate, lag_opi_famille, lag_opi_work_fem,
                                     lag_pib_hab, lag_acceuilenf, lag_opi_niveau_vie))

# Sauvegarder les résultats
write_xlsx(data_work, "C:/Users/PC/Documents/Cours/Master/S1/Econométrie TD/Projet/Data_Work.xlsx")
write_xlsx(Variables_instrumentales, "C:/Users/PC/Documents/Cours/Master/S1/Econométrie TD/Projet/Variables_Instrumentales.xlsx")

library(dplyr)
rm(data)
rm(data_clean)

data_work_trend <- read_xlsx("C:/Users/PC/Documents/Cours/Master/S1/Econométrie TD/Projet/Data_Work_trend.xlsx")

# Renommer 'fec_diff_relative' en 'fec'
data_work_trend <- data_work_trend %>%
  rename(fec = fec_var_relative)

# 1. Modèle standardisé (centré et réduit)
data_model_standardized <- data_work_trend %>%
  mutate(across(starts_with("lag_"), ~ scale(.)))

model_standardized <- lm(fec ~ . - Temps, data = data_model_standardized)
# Étape 2 : Calculer les résidus bruts et standardisés
residuals_standardized_df <- data.frame(
  Index = seq_len(nrow(data_work_trend)),
  Resid = residuals(model_standardized),      # Résidus bruts
  Std_Resid = rstandard(model_standardized),  # Résidus standardisés
  Temps = data_work_trend$Temps,
  fec = data_work_trend$fec
)
```

```{r résidus}
threshold_zoom <- 3
plot_residus_standardises <- ggplot(residuals_standardized_df %>% filter(abs(Std_Resid) <= threshold_zoom)) +
  geom_point(aes(x = Index, y = Std_Resid), color = "blue") +
  geom_hline(yintercept = c(-1, 1), color = "red", linetype = "dashed") +
  labs(
    title = "Résidus Standardisés (Zoomé)",
    x = "Index d'observation",
    y = "Résidus standardisés"
  ) +
  theme_minimal()

print(plot_residus_standardises)

```

``` {r outliers, include=TRUE}
# Étape 5 : Identifier les outliers
threshold <-2   # Seuil pour identifier les outliers
outliers_standardized_df <- residuals_standardized_df %>%
  filter(abs(Std_Resid) > threshold)

cat("\n### Résumé des outliers identifiés ###\n")
print(outliers_standardized_df)
# Étape 6 : Créer un nouveau DataFrame sans les outliers (`data_work2`)
data_work2 <- data_work_trend %>%
  mutate(Index = seq_len(nrow(data_work_trend))) %>%
  filter(!Index %in% outliers_standardized_df$Index) %>%
  select(-Index)
```   

## III. Tri des variables 
### III.1. Détection et suppression des variables ayant de la colinéarité parfaite (Alias)
### III.2. Sélection de variables pertinantes (MDS, réseau, matrice de colinéarité)
### III.3. Test VIF et suppression des varaibles avec un VIF élevé

## IV. Première regression
### A. Résultats
### B. Tests des hypothèses de Gauss-Markov

## V. Deuxième regression
### A. Détrendisation
### B. GLS

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
